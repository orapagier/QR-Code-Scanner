<!DOCTYPE html>
<html>
  <head>
    <title>QR Code Scanner - JSONP Version</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 4px solid #f39c12;
        background-color: #fef9e7;
        color: #8a6d3b;
      }
      .alert.error {
        border-left-color: #e74c3c;
        background-color: #f2dede;
        color: #a94442;
      }
      .alert.success {
        border-left-color: #27ae60;
        background-color: #dff0d8;
        color: #3c763d;
      }
      #reader {
        width: 100%;
        max-width: 400px;
        margin: 0 auto 20px auto;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      #result {
        font-size: 16px;
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
        word-wrap: break-word;
      }
      #history {
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        background-color: #f8f9fa;
      }
      .history-item {
        padding: 10px;
        margin: 5px 0;
        background-color: white;
        border-radius: 3px;
        border-left: 3px solid #007bff;
        font-size: 14px;
        word-break: break-all;
      }
      .history-item.saved {
        border-left-color: #28a745;
      }
      .history-item.error {
        border-left-color: #dc3545;
      }
      .button {
        display: block;
        margin: 10px auto;
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        min-width: 120px;
      }
      #stop-button {
        background-color: #dc3545;
        color: white;
        display: none;
      }
      #stop-button:hover {
        background-color: #c82333;
      }
      #start-button {
        background-color: #007bff;
        color: white;
        display: none;
      }
      #start-button:hover {
        background-color: #0056b3;
      }
      #clear-button {
        background-color: #6c757d;
        color: white;
        font-size: 14px;
        padding: 8px 16px;
        min-width: auto;
      }
      #clear-button:hover {
        background-color: #545b62;
      }
      .status {
        text-align: center;
        margin: 10px 0;
        font-weight: bold;
      }
      .success { color: #28a745; }
      .error { color: #dc3545; }
      .info { color: #007bff; }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .stats {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        text-align: center;
      }
      .stat-item {
        flex: 1;
        padding: 10px;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }
      .jsonp-indicator {
        background-color: #e3f2fd;
        border: 1px solid #2196f3;
        color: #1976d2;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üîê Secure QR Scanner (JSONP)</h2>
      
      <div class="jsonp-indicator">
        ‚ö° Using JSONP for cross-origin requests - No CORS issues!
      </div>
      
      <div id="config-status" class="alert">
        <strong>API Status:</strong> <span id="config-message">Testing JSONP connection...</span>
      </div>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="total-scans">0</div>
          <div class="stat-label">Total Scans</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="successful-saves">0</div>
          <div class="stat-label">Saved to Sheets</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="failed-saves">0</div>
          <div class="stat-label">Failed Saves</div>
        </div>
      </div>
      
      <div id="reader"></div>
      <div id="result"></div>
      <div id="status" class="status"></div>
      
      <button id="start-button" class="button" onclick="startScanner()">Start Scanner</button>
      <button id="stop-button" class="button" onclick="stopScanner()">Stop Scanner</button>
      
      <div id="history">
        <h3 style="margin-top: 0; text-align: center;">
          Scan History 
          <button id="clear-button" class="button" onclick="clearHistory()" style="display: inline-block; margin-left: 10px;">Clear History</button>
        </h3>
        <div id="history-list"></div>
      </div>
    </div>

    <script>
      // ==========================================
      // JSONP CONFIGURATION
      // ==========================================
      const CONFIG = {
        // Replace with your Google Apps Script Web App URL
        API_ENDPOINT: 'https://script.google.com/macros/s/AKfycbz6xdFm6SyKQdh6_ruDgyiXpFgeDYu-mYh-X7afmNnXx9bt_9H5IPauL_YCQe6rSHh5/exec'
      };
      
      // ==========================================
      // JSONP HELPER FUNCTIONS
      // ==========================================
      
      function makeJSONPRequest(url, params = {}) {
        return new Promise((resolve, reject) => {
          // Create unique callback name
          const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          
          // Create global callback function
          window[callbackName] = function(data) {
            // Clean up
            delete window[callbackName];
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
            
            // Resolve with data
            resolve(data);
          };
          
          // Build URL with parameters
          const urlParams = new URLSearchParams({
            callback: callbackName,
            ...params,
            _t: Date.now() // Cache buster
          });
          
          // Create script element
          const script = document.createElement('script');
          script.src = url + '?' + urlParams.toString();
          
          // Handle errors
          script.onerror = function() {
            // Clean up
            delete window[callbackName];
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
            reject(new Error('JSONP request failed - network error'));
          };
          
          // Add to DOM to trigger request
          document.body.appendChild(script);
          
          // Set timeout
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              if (document.body.contains(script)) {
                document.body.removeChild(script);
              }
              reject(new Error('JSONP request timeout'));
            }
          }, 15000); // 15 second timeout
        });
      }
      
      // ==========================================
      // APPLICATION CODE
      // ==========================================
      let html5QrCode = null;
      let isScanning = false;
      let scanHistory = [];
      let stats = {
        totalScans: 0,
        successfulSaves: 0,
        failedSaves: 0
      };

      function updateStats() {
        document.getElementById('total-scans').textContent = stats.totalScans;
        document.getElementById('successful-saves').textContent = stats.successfulSaves;
        document.getElementById('failed-saves').textContent = stats.failedSaves;
      }

      async function checkApiConnection() {
        const configStatus = document.getElementById('config-status');
        const configMessage = document.getElementById('config-message');
        
        if (CONFIG.API_ENDPOINT.includes('YOUR_SCRIPT_ID')) {
          configStatus.className = 'alert error';
          configMessage.textContent = 'Please configure your Google Apps Script endpoint.';
          return false;
        }
        
        try {
          configMessage.textContent = 'Testing JSONP connection...';
          
          const data = await makeJSONPRequest(CONFIG.API_ENDPOINT, {
            action: 'status'
          });
          
          if (data.success || data.status) {
            configStatus.className = 'alert success';
            configMessage.textContent = '‚úÖ JSONP connection successful! Ready to scan.';
            return true;
          } else {
            throw new Error('Invalid API response');
          }
        } catch (error) {
          configStatus.className = 'alert error';
          configMessage.textContent = `‚ùå JSONP connection failed: ${error.message}`;
          return false;
        }
      }

      function updateStatus(message, type = 'info') {
        const statusElement = document.getElementById('status');
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
      }

      function showLoading(message) {
        const statusElement = document.getElementById('status');
        statusElement.innerHTML = `${message}<span class="loading"></span>`;
        statusElement.className = 'status info';
      }

      async function saveToSecureAPI(qrData) {
        console.log('Saving QR data via JSONP:', qrData);
        
        const result = await makeJSONPRequest(CONFIG.API_ENDPOINT, {
          qrData: qrData
        });
        
        if (!result.success) {
          throw new Error(result.error || 'Unknown API error');
        }
        
        return result;
      }

      function addToHistory(text, saved = false, error = null) {
        const timestamp = new Date().toLocaleString();
        scanHistory.unshift({ text, timestamp, saved, error });
        
        // Keep only last 20 scans
        if (scanHistory.length > 20) {
          scanHistory = scanHistory.slice(0, 20);
        }
        
        updateHistoryDisplay();
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        
        if (scanHistory.length === 0) {
          historyList.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No scans yet</div>';
          return;
        }
        
        scanHistory.forEach(item => {
          const div = document.createElement('div');
          div.className = `history-item ${item.saved ? 'saved' : (item.error ? 'error' : '')}`;
          
          let statusIcon = '';
          let statusText = '';
          if (item.saved) {
            statusIcon = '‚ö°‚úÖ';
            statusText = 'Saved via JSONP';
          } else if (item.error) {
            statusIcon = '‚ùå';
            statusText = `Error: ${item.error}`;
          } else {
            statusIcon = '‚è≥';
            statusText = 'Processing...';
          }
          
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <div style="font-weight: bold; color: #666; font-size: 12px;">${item.timestamp}</div>
              <div style="font-size: 12px; color: ${item.saved ? '#28a745' : (item.error ? '#dc3545' : '#6c757d')};">
                ${statusIcon} ${statusText}
              </div>
            </div>
            <div style="font-family: monospace; background-color: #f8f9fa; padding: 5px; border-radius: 3px;">${item.text}</div>
          `;
          historyList.appendChild(div);
        });
      }

      function clearHistory() {
        scanHistory = [];
        stats = { totalScans: 0, successfulSaves: 0, failedSaves: 0 };
        updateHistoryDisplay();
        updateStats();
      }

      async function onScanSuccess(decodedText, decodedResult) {
        console.log('Scan successful:', decodedText);
        document.getElementById("result").innerHTML = `<strong>Latest Scan:</strong><br><code>${decodedText}</code>`;
        
        // Update stats
        stats.totalScans++;
        updateStats();
        
        // Add to history first (will show as processing)
        addToHistory(decodedText, false, null);
        
        // Show start button for next scan
        document.getElementById("stop-button").style.display = "none";
        document.getElementById("start-button").style.display = "block";
        
        // Stop the scanner
        stopScanner();
        
        // Show loading status
        showLoading('Saving via JSONP...');
        
        try {
          const result = await saveToSecureAPI(decodedText);
          
          console.log('Save successful:', result);
          
          // Update the latest history item
          if (scanHistory.length > 0) {
            scanHistory[0].saved = true;
            scanHistory[0].error = null;
          }
          
          stats.successfulSaves++;
          updateStats();
          updateHistoryDisplay();
          updateStatus('‚ö°‚úÖ Scan successful! Saved via JSONP to Google Sheets.', 'success');
          
        } catch (error) {
          console.error('Failed to save via JSONP:', error);
          
          // Update the latest history item
          if (scanHistory.length > 0) {
            scanHistory[0].saved = false;
            scanHistory[0].error = error.message;
          }
          
          stats.failedSaves++;
          updateStats();
          updateHistoryDisplay();
          updateStatus(`‚ùå Failed to save: ${error.message}`, 'error');
        }
      }

      function onScanFailure(error) {
        // Ignore scan failures - they happen frequently during scanning
      }

      function startScanner() {
        if (isScanning) return;
        
        updateStatus('Starting camera...', 'info');
        html5QrCode = new Html5Qrcode("reader");
        
        Html5Qrcode.getCameras().then(devices => {
          if (devices && devices.length) {
            // Try to use back camera first (usually better for QR scanning)
            let selectedCamera = devices[0];
            for (let device of devices) {
              if (device.label && device.label.toLowerCase().includes('back')) {
                selectedCamera = device;
                break;
              }
            }
            
            const config = {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1.0
            };
            
            html5QrCode.start(selectedCamera.id, config, onScanSuccess, onScanFailure)
              .then(() => {
                isScanning = true;
                updateStatus('üì∑ Scanner active - point camera at QR code', 'success');
                document.getElementById("stop-button").style.display = "block";
                document.getElementById("start-button").style.display = "none";
              })
              .catch(err => {
                console.error('Failed to start scanner:', err);
                updateStatus('Failed to start camera. Please allow camera access.', 'error');
                document.getElementById("start-button").style.display = "block";
              });
          } else {
            updateStatus('No camera found on this device', 'error');
            document.getElementById("start-button").style.display = "block";
          }
        }).catch(err => {
          console.error('Camera error:', err);
          updateStatus(`Camera error: ${err.message || err}`, 'error');
          document.getElementById("start-button").style.display = "block";
        });
      }

      function stopScanner() {
        if (html5QrCode && isScanning) {
          html5QrCode.stop().then(() => {
            isScanning = false;
            document.getElementById("stop-button").style.display = "none";
            document.getElementById("start-button").style.display = "block";
            updateStatus('Scanner stopped', 'info');
          }).catch(err => {
            console.error('Failed to stop scanner:', err);
            isScanning = false;
            document.getElementById("stop-button").style.display = "none";
            document.getElementById("start-button").style.display = "block";
          });
        }
      }

      // Initialize the scanner when page loads
      window.onload = async function() {
        updateStats();
        
        // Check if we're in a secure context (required for camera access)
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          updateStatus('Camera access not available. Please use HTTPS.', 'error');
          return;
        }
        
        document.getElementById("start-button").style.display = "block";
        
        const apiConnected = await checkApiConnection();
        if (apiConnected) {
          updateStatus('‚ö° Ready! JSONP connection established. Click "Start Scanner" to begin.', 'info');
        } else {
          updateStatus('Please configure JSONP API endpoint first', 'error');
        }
      };

      // Clean up when page unloads
      window.onbeforeunload = function() {
        if (html5QrCode && isScanning) {
          html5QrCode.stop();
        }
      };
    </script>
  </body>
</html>
