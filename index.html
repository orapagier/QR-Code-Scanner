<!DOCTYPE html>
<html>
  <head>
    <title>QR Code Scanner - JSONP Version</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 4px solid #f39c12;
        background-color: #fef9e7;
        color: #8a6d3b;
      }
      .alert.error {
        border-left-color: #e74c3c;
        background-color: #f2dede;
        color: #a94442;
      }
      .alert.success {
        border-left-color: #27ae60;
        background-color: #dff0d8;
        color: #3c763d;
      }
      #reader {
        width: 100%;
        max-width: 400px;
        margin: 0 auto 20px auto;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      #result {
        font-size: 16px;
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
        word-wrap: break-word;
      }
      #history {
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        background-color: #f8f9fa;
      }
      .history-item {
        padding: 10px;
        margin: 5px 0;
        background-color: white;
        border-radius: 3px;
        border-left: 3px solid #007bff;
        font-size: 14px;
        word-break: break-all;
      }
      .history-item.saved {
        border-left-color: #28a745;
      }
      .history-item.error {
        border-left-color: #dc3545;
      }
      .button {
        display: block;
        margin: 10px auto;
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        min-width: 120px;
      }
      #stop-button {
        background-color: #dc3545;
        color: white;
        display: none;
      }
      #stop-button:hover {
        background-color: #c82333;
      }
      #start-button {
        background-color: #007bff;
        color: white;
        display: none;
      }
      #start-button:hover {
        background-color: #0056b3;
      }
      #clear-button {
        background-color: #6c757d;
        color: white;
        font-size: 14px;
        padding: 8px 16px;
        min-width: auto;
      }
      #clear-button:hover {
        background-color: #545b62;
      }
      .status {
        text-align: center;
        margin: 10px 0;
        font-weight: bold;
      }
      .success { color: #28a745; }
      .error { color: #dc3545; }
      .info { color: #007bff; }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .stats {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        text-align: center;
      }
      .stat-item {
        flex: 1;
        padding: 10px;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }
      
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease-in-out;
      }
      
      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .modal h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 20px;
      }
      
      .modal p {
        color: #666;
        margin-bottom: 25px;
        font-size: 16px;
        line-height: 1.4;
      }
      
      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }
      
      .modal-button {
        padding: 12px 30px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
        min-width: 100px;
      }
      
      .modal-button.yes {
        background-color: #28a745;
        color: white;
      }
      
      .modal-button.yes:hover {
        background-color: #218838;
        transform: translateY(-1px);
      }
      
      .modal-button.no {
        background-color: #dc3545;
        color: white;
      }
      
      .modal-button.no:hover {
        background-color: #c82333;
        transform: translateY(-1px);
      }
      
      .uniform-indicator {
        display: inline-block;
        margin-left: 10px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }
      
      .uniform-yes {
        background-color: #d4edda;
        color: #155724;
      }
      
      .uniform-no {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>NEMA QR Scanner</h2>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="total-scans">0</div>
          <div class="stat-label">Total Scans</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="successful-saves">0</div>
          <div class="stat-label">Saved to Sheets</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="failed-saves">0</div>
          <div class="stat-label">Failed Saves</div>
        </div>
      </div>
      
      <div id="reader"></div>
      <div id="result"></div>
      <div id="status" class="status"></div>
      
      <button id="start-button" class="button" onclick="startScanner()">Start Scanner</button>
      <button id="stop-button" class="button" onclick="stopScanner()">Stop Scanner</button>
      
      <div id="history">
        <h3 style="margin-top: 0; text-align: center;">
          Scan History 
          <button id="clear-button" class="button" onclick="clearHistory()" style="display: inline-block; margin-left: 10px;">Clear History</button>
        </h3>
        <div id="history-list"></div>
      </div>
    </div>

    <!-- Uniform Check Modal -->
    <div id="uniformModal" class="modal">
      <div class="modal-content">
        <h3>üéØ Uniform Check</h3>
        <p>Is this person wearing proper uniform?</p>
        <div class="modal-buttons">
          <button class="modal-button yes" onclick="confirmUniform(true)">‚úÖ Yes</button>
          <button class="modal-button no" onclick="confirmUniform(false)">‚ùå No</button>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // JSONP CONFIGURATION
      // ==========================================
      const CONFIG = {
        // Replace with your Google Apps Script Web App URL
        API_ENDPOINT: 'https://script.google.com/macros/s/AKfycbwxXmYg-gTn75S-or0N67iJQprzmEuKeGOJMbzQhhDhqVbG3bRHBJD5m5PbKdYe_iy-/exec'
      };
      
      // ==========================================
      // JSONP HELPER FUNCTIONS
      // ==========================================
      
      function makeJSONPRequest(url, params = {}) {
        return new Promise((resolve, reject) => {
          // Create unique callback name
          const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          
          // Create global callback function
          window[callbackName] = function(data) {
            // Clean up
            delete window[callbackName];
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
            
            // Resolve with data
            resolve(data);
          };
          
          // Build URL with parameters
          const urlParams = new URLSearchParams({
            callback: callbackName,
            ...params,
            _t: Date.now() // Cache buster
          });
          
          // Create script element
          const script = document.createElement('script');
          script.src = url + '?' + urlParams.toString();
          
          // Handle errors
          script.onerror = function() {
            // Clean up
            delete window[callbackName];
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
            reject(new Error('JSONP request failed - network error'));
          };
          
          // Add to DOM to trigger request
          document.body.appendChild(script);
          
          // Set timeout
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              if (document.body.contains(script)) {
                document.body.removeChild(script);
              }
              reject(new Error('JSONP request timeout'));
            }
          }, 15000); // 15 second timeout
        });
      }
      
      // ==========================================
      // APPLICATION CODE
      // ==========================================
      let html5QrCode = null;
      let isScanning = false;
      let scanHistory = [];
      let stats = {
        totalScans: 0,
        successfulSaves: 0,
        failedSaves: 0
      };
      
      // Store current scan data for uniform check
      let currentScanData = null;

      function updateStats() {
        document.getElementById('total-scans').textContent = stats.totalScans;
        document.getElementById('successful-saves').textContent = stats.successfulSaves;
        document.getElementById('failed-saves').textContent = stats.failedSaves;
      }

      async function checkApiConnection() {
        if (CONFIG.API_ENDPOINT.includes('YOUR_SCRIPT_ID')) {
          return false;
        }
        
        try {
          const data = await makeJSONPRequest(CONFIG.API_ENDPOINT, {
            action: 'status'
          });
          
          return data.success || data.status || true; // Return true if any success indicator
        } catch (error) {
          console.log('API connection test failed, but continuing anyway:', error.message);
          return true; // Continue anyway - the actual save might still work
        }
      }

      function updateStatus(message, type = 'info') {
        const statusElement = document.getElementById('status');
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
      }

      function showLoading(message) {
        const statusElement = document.getElementById('status');
        statusElement.innerHTML = `${message}<span class="loading"></span>`;
        statusElement.className = 'status info';
      }

      async function saveToSecureAPI(qrData, uniformCompliance) {
        console.log('Saving QR data via JSONP:', qrData, 'Uniform:', uniformCompliance);
        
        const result = await makeJSONPRequest(CONFIG.API_ENDPOINT, {
          qrData: qrData,
          uniformCompliance: uniformCompliance ? 'Yes' : 'No'
        });
        
        // More flexible success checking
        if (result.success === false) {
          throw new Error(result.error || 'Save failed');
        }
        
        return result;
      }

      function addToHistory(text, saved = false, error = null, uniformCompliance = null) {
        const timestamp = new Date().toLocaleString();
        scanHistory.unshift({ text, timestamp, saved, error, uniformCompliance });
        
        // Keep only last 20 scans
        if (scanHistory.length > 20) {
          scanHistory = scanHistory.slice(0, 20);
        }
        
        updateHistoryDisplay();
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        
        if (scanHistory.length === 0) {
          historyList.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No scans yet</div>';
          return;
        }
        
        scanHistory.forEach(item => {
          const div = document.createElement('div');
          div.className = `history-item ${item.saved ? 'saved' : (item.error ? 'error' : '')}`;
          
          let statusIcon = '';
          let statusText = '';
          if (item.saved) {
            statusIcon = '‚úÖ';
            statusText = 'Saved to Sheets';
          } else if (item.error) {
            statusIcon = '‚ùå';
            statusText = `Error: ${item.error}`;
          } else {
            statusIcon = '‚è≥';
            statusText = 'Processing...';
          }
          
          let uniformIndicator = '';
          if (item.uniformCompliance !== null) {
            uniformIndicator = `<span class="uniform-indicator ${item.uniformCompliance ? 'uniform-yes' : 'uniform-no'}">
              ${item.uniformCompliance ? 'üëî PROPER' : '‚ö†Ô∏è IMPROPER'}
            </span>`;
          }
          
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <div style="font-weight: bold; color: #666; font-size: 12px;">${item.timestamp}</div>
              <div style="font-size: 12px; color: ${item.saved ? '#28a745' : (item.error ? '#dc3545' : '#6c757d')};">
                ${statusIcon} ${statusText}
              </div>
            </div>
            <div style="font-family: monospace; background-color: #f8f9fa; padding: 5px; border-radius: 3px; margin-bottom: 5px;">${item.text}</div>
            ${uniformIndicator}
          `;
          historyList.appendChild(div);
        });
      }

      function clearHistory() {
        scanHistory = [];
        stats = { totalScans: 0, successfulSaves: 0, failedSaves: 0 };
        updateHistoryDisplay();
        updateStats();
      }

      function showUniformModal(qrData) {
        currentScanData = qrData;
        document.getElementById('uniformModal').style.display = 'block';
        updateStatus('üëî Please check uniform compliance', 'info');
      }

      function confirmUniform(hasProperUniform) {
        // Hide modal
        document.getElementById('uniformModal').style.display = 'none';
        
        if (currentScanData) {
          // Update the latest history item with uniform compliance
          if (scanHistory.length > 0) {
            scanHistory[0].uniformCompliance = hasProperUniform;
            updateHistoryDisplay();
          }
          
          // Proceed with saving
          proceedWithSave(currentScanData, hasProperUniform);
          currentScanData = null;
        }
      }

      async function proceedWithSave(qrData, uniformCompliance) {
        // Show loading status
        showLoading('Saving to Google Sheets...');
        
        try {
          const result = await saveToSecureAPI(qrData, uniformCompliance);
          
          console.log('Save result:', result);
          
          // Update the latest history item
          if (scanHistory.length > 0) {
            scanHistory[0].saved = true;
            scanHistory[0].error = null;
          }
          
          stats.successfulSaves++;
          updateStats();
          updateHistoryDisplay();
          updateStatus('‚úÖ Scan saved successfully!', 'success');
          
        } catch (error) {
          console.error('Failed to save:', error);
          
          // Update the latest history item
          if (scanHistory.length > 0) {
            scanHistory[0].saved = false;
            scanHistory[0].error = error.message;
          }
          
          stats.failedSaves++;
          updateStats();
          updateHistoryDisplay();
          updateStatus(`‚ùå Failed to save: ${error.message}`, 'error');
        }
      }

      async function onScanSuccess(decodedText, decodedResult) {
        console.log('Scan successful:', decodedText);
        document.getElementById("result").innerHTML = `<strong>Latest Scan:</strong><br><code>${decodedText}</code>`;
        
        // Update stats
        stats.totalScans++;
        updateStats();
        
        // Add to history first (will show as processing)
        addToHistory(decodedText, false, null, null);
        
        // Show start button for next scan
        document.getElementById("stop-button").style.display = "none";
        document.getElementById("start-button").style.display = "block";
        
        // Stop the scanner
        stopScanner();
        
        // Show uniform compliance modal
        showUniformModal(decodedText);
      }

      function onScanFailure(error) {
        // Ignore scan failures - they happen frequently during scanning
      }

      function startScanner() {
        if (isScanning) return;
        
        updateStatus('Starting camera...', 'info');
        html5QrCode = new Html5Qrcode("reader");
        
        Html5Qrcode.getCameras().then(devices => {
          if (devices && devices.length) {
            // Try to use back camera first (usually better for QR scanning)
            let selectedCamera = devices[0];
            for (let device of devices) {
              if (device.label && device.label.toLowerCase().includes('back')) {
                selectedCamera = device;
                break;
              }
            }
            
            const config = {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1.0
            };
            
            html5QrCode.start(selectedCamera.id, config, onScanSuccess, onScanFailure)
              .then(() => {
                isScanning = true;
                updateStatus('üì∑ Scanner Active - Point Camera at QR code', 'success');
                document.getElementById("stop-button").style.display = "block";
                document.getElementById("start-button").style.display = "none";
              })
              .catch(err => {
                console.error('Failed to start scanner:', err);
                updateStatus('Failed to start camera. Please allow camera access.', 'error');
                document.getElementById("start-button").style.display = "block";
              });
          } else {
            updateStatus('No camera found on this device', 'error');
            document.getElementById("start-button").style.display = "block";
          }
        }).catch(err => {
          console.error('Camera error:', err);
          updateStatus(`Camera error: ${err.message || err}`, 'error');
          document.getElementById("start-button").style.display = "block";
        });
      }

      function stopScanner() {
        if (html5QrCode && isScanning) {
          html5QrCode.stop().then(() => {
            isScanning = false;
            document.getElementById("stop-button").style.display = "none";
            document.getElementById("start-button").style.display = "block";
            updateStatus('Scanner stopped', 'info');
          }).catch(err => {
            console.error('Failed to stop scanner:', err);
            isScanning = false;
            document.getElementById("stop-button").style.display = "none";
            document.getElementById("start-button").style.display = "block";
          });
        }
      }

      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById('uniformModal');
        if (event.target === modal) {
          // Don't close the modal by clicking outside - force user to make a choice
          updateStatus('üëî Please select Yes or No for uniform compliance', 'info');
        }
      }

      // Initialize the scanner when page loads
      window.onload = async function() {
        updateStats();
        
        // Check if we're in a secure context (required for camera access)
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          updateStatus('Camera access not available. Please use HTTPS.', 'error');
          return;
        }
        
        document.getElementById("start-button").style.display = "block";
        
        const apiConnected = await checkApiConnection();
        updateStatus('Ready to scan! Click "Start Scanner" to begin.', 'info');
      };

      // Clean up when page unloads
      window.onbeforeunload = function() {
        if (html5QrCode && isScanning) {
          html5QrCode.stop();
        }
      };
    </script>
  </body>
</html>
